# M4 â€” Core User Profiles

> **Goal**: Every registered user has a public profile page at `https://yotop10.com/@username`. By the end of M4, you can visit any user's profile, see their bio, avatar, badge display, post history, and author tier. Follow and connect buttons are visible (actions wired in M10). Privacy enforcement is active â€” private profiles show nothing to non-connections.

---

## Architecture Overview

```
Browser
â”‚
â”œâ”€â”€ /@ username            â†’ public profile page (SSR â€” SEO-friendly)
â”‚   â”œâ”€â”€ Avatar + display name + bio
â”‚   â”œâ”€â”€ Author tier badge (if applicable)
â”‚   â”œâ”€â”€ Badge collection display
â”‚   â”œâ”€â”€ Post history (approved posts, newest first)
â”‚   â”œâ”€â”€ Follow / Connect buttons (UI only â€” logic in M10)
â”‚   â””â”€â”€ Privacy gate (if profile is private or connections-only)
â”‚
â””â”€â”€ /settings/profile      â†’ edit profile (authenticated only)
    â”œâ”€â”€ Upload avatar
    â”œâ”€â”€ Edit bio + display name
    â””â”€â”€ Privacy settings toggle

FastAPI Backend
â”‚
â”œâ”€â”€ GET  /users/{username}          â†’ fetch public profile
â”œâ”€â”€ GET  /users/{username}/posts    â†’ fetch user's post history
â”œâ”€â”€ PATCH /users/me                 â†’ update own profile
â””â”€â”€ POST  /users/me/avatar          â†’ upload avatar image to MinIO
```

**Key decisions:**
- Profile pages are **server-side rendered (SSR)** in Next.js â€” Google can crawl them, links shared on social media show OG cards
- Avatars stored in **MinIO**, served from **`cdn.yotop10.com`**
- Privacy has 3 levels: **Public** (anyone), **Connections-only** (approved connections), **Private** (only self)
- The `@username` URL pattern (like Twitter/X) is chosen over `/user/123` â€” it's human-readable and shareable

---

## Prerequisites

- M3 complete â€” authentication working, users can register and log in âœ…
- M2 complete â€” `users` and `badges` tables exist âœ…
- MinIO running with `yotop10-media` bucket âœ…

---

## Step 1 â€” ğŸ’» LOCAL: Build the User Schema Layer

**`backend/app/schemas/user.py`** â€” defines what the profile API returns:

### Public Profile Response
This is what anyone can see on a public profile:
```python
class UserProfile:
    id: UUID
    username: str
    display_name: str
    bio: str | None
    avatar_url: str | None         # full CDN URL: https://cdn.yotop10.com/...
    author_tier: bool              # True if they have Author status
    badges: list[BadgeInfo]        # list of earned badge names + icons
    post_count: int                # total approved posts
    follower_count: int
    following_count: int
    joined_at: datetime
    privacy: str                   # "public" / "connections" / "private"
```

### Profile Update Request (authenticated user's own profile):
```python
class ProfileUpdateRequest:
    display_name: str | None       # optional â€” only update what's sent
    bio: str | None                # max 300 chars
    privacy: str | None            # "public" / "connections" / "private"
```

> Using `| None` on all fields makes them optional â€” the user can update just their bio without sending all their profile data again. The backend only updates fields that are provided.

---

## Step 2 â€” ğŸ’» LOCAL: Build the User CRUD Layer

**`backend/app/crud/user.py`** already has some functions from M3. Add these:

| Function | What it does |
|---|---|
| `get_user_by_username(db, username)` | Look up profile by `@username` |
| `get_user_posts(db, user_id, viewer_id)` | Get user's posts, respecting privacy |
| `get_user_badges(db, user_id)` | Get list of earned badges |
| `update_profile(db, user, data)` | Update display_name / bio / privacy |
| `update_avatar(db, user, avatar_url)` | Store new avatar CDN URL |
| `get_follower_count(db, user_id)` | Count followers |
| `get_following_count(db, user_id)` | Count who they follow |

> The `get_user_posts` function takes both `user_id` (whose posts) and `viewer_id` (who is asking). The viewer's relationship to the profile owner determines which posts are visible â€” public posts always show, private posts only show to the owner.

---

## Step 3 â€” ğŸ’» LOCAL: Build the Avatar Upload Service

**`backend/app/services/user.py`** handles profile updates and avatar uploads.

### How avatar upload works:

```
1. User selects image on frontend
2. Frontend calls POST /api/users/me/avatar with the image file (multipart/form-data)
3. Backend receives the file
4. Validate: max 5MB, must be JPEG or PNG
5. Resize to 400x400px (using Pillow library)
6. Generate unique filename: avatars/{user_id}/{timestamp}.jpg
7. Upload to MinIO bucket (yotop10-media)
8. Construct public CDN URL: https://cdn.yotop10.com/yotop10-media/avatars/{user_id}/{timestamp}.jpg
9. Store that URL in users.avatar_url
10. Return the new avatar_url to the frontend
```

> **Why resize server-side?** Users upload huge phone photos. Resizing to 400x400 on the backend means fast loads for everyone and no wasted storage.

> **Add `Pillow` to requirements.txt** for image resizing:
> ```
> Pillow==10.4.0
> ```

### MinIO upload code pattern:
```python
from minio import Minio

minio = Minio(
    settings.MINIO_ENDPOINT,
    access_key=settings.MINIO_ACCESS_KEY,
    secret_key=settings.MINIO_SECRET_KEY,
    secure=settings.MINIO_SECURE
)

minio.put_object(
    bucket_name=settings.MINIO_BUCKET,
    object_name=object_path,      # avatars/user_id/timestamp.jpg
    data=image_bytes,
    length=len(image_bytes),
    content_type="image/jpeg"
)
```

---

## Step 4 â€” ğŸ’» LOCAL: Build the Profile API Endpoints

**`backend/app/api/v1/users.py`** â€” 4 endpoints:

| Method | Path | Auth required | What it does |
|---|---|---|---|
| `GET` | `/users/{username}` | No | Get public profile data |
| `GET` | `/users/{username}/posts` | Optional | Get user's post history |
| `PATCH` | `/users/me` | Yes | Update own profile (bio, display name, privacy) |
| `POST` | `/users/me/avatar` | Yes | Upload new avatar image |

### Privacy enforcement in `GET /users/{username}`:
```
If profile.privacy == "public":
    â†’ return full profile to anyone

If profile.privacy == "connections":
    â†’ if viewer is a confirmed connection â†’ return full profile
    â†’ if viewer is not a connection â†’ return limited view (name, avatar only)
    â†’ if viewer not logged in â†’ return limited view

If profile.privacy == "private":
    â†’ if viewer is the owner â†’ return full profile
    â†’ everyone else â†’ return 404 (profile doesn't exist to them)
```

> Returning 404 for private profiles (instead of 403) is a deliberate privacy choice â€” revealing that a private account exists would be a privacy leak.

Wire into `backend/main.py`:
```python
app.include_router(users_router, prefix="/users", tags=["users"])
```

---

## Step 5 â€” ğŸ’» LOCAL: Build the Profile Page (Frontend)

**`frontend/src/app/@[username]/page.tsx`** â€” the public profile page.

> The `@` in the folder name is a Next.js parallel route segment. The URL `/@ username` maps to this file.

### What gets rendered per privacy level:

**Public profile** (viewer sees everything):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Avatar]  Display Name          â”‚
â”‚           @username             â”‚
â”‚           Bio text here         â”‚
â”‚           ğŸ“… Joined Feb 2026    â”‚
â”‚                                 â”‚
â”‚  [Author] [ğŸ”¥ Hot Lister] [...]  â”‚ â† badges
â”‚                                 â”‚
â”‚  42 posts Â· 128 followers       â”‚
â”‚  [Follow] [Connect]             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Posts                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Top 10 Greatest...   â”‚       â”‚
â”‚  â”‚ ğŸ”¥ 48  ğŸ’¬ 12         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ This vs That: ...    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Connections-only profile** (non-connection sees):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Avatar]  Display Name          â”‚
â”‚           @username             â”‚
â”‚                                 â”‚
â”‚  This profile is connections    â”‚
â”‚  only. [Connect] to see more.   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data fetching:
Since this is an SSR page, fetch the profile data at render time:
```typescript
// This runs on the server â€” great for SEO
const profile = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/users/${username}`)

// OG meta tags for social sharing
export const generateMetadata = async ({ params }) => ({
  title: `${profile.display_name} (@${username}) â€” YoTop10`,
  description: profile.bio,
  openGraph: {
    images: [profile.avatar_url],
  }
})
```

---

## Step 6 â€” ğŸ’» LOCAL: Build the Profile Settings Page

**`frontend/src/app/settings/profile/page.tsx`** â€” authenticated users edit their own profile here.

### Three sections:

**1. Avatar Upload**
- Shows current avatar
- "Change photo" button â†’ opens file picker (accepts .jpg, .png, max 5MB)
- On file select â†’ preview it immediately (no upload yet)
- "Save" â†’ uploads via `POST /api/users/me/avatar` (multipart form)
- Shows upload progress bar
- On success â†’ updates avatar everywhere on page immediately

**2. Profile Info**
- Display name field (50 char max)
- Bio textarea (300 char max) with character counter
- Save button â†’ `PATCH /api/users/me` with changed fields
- Shows success/error toast

**3. Privacy Settings**
- Radio button group:
  - ğŸŒ Public â€” anyone can see your profile
  - ğŸ”’ Connections only â€” only approved connections
  - ğŸš« Private â€” only you
- Changes save immediately on selection (auto-save, no button)

---

## Step 7 â€” ğŸ’» LOCAL: Badge Display Component

Badges are earned automatically or granted by admin (M21 covers earning logic â€” M4 just displays them).

Create `frontend/src/components/BadgeRow.tsx`:

```
[Author ğŸ–‹ï¸] [Hot Lister ğŸ”¥] [Fact Master ğŸ“Š]
```

Each badge is an icon + label in a pill style. Hovering shows the badge description:
- **Author** â€” 20 approved posts
- **Hot Lister** â€” 3+ posts hit CONTESTED or CONFIRMED verdict
- **Fact Master** â€” 5+ fact-drop posts approved

The backend returns badge data with the profile. The component just renders what it receives â€” no logic needed here.

---

## Step 8 â€” ğŸ’» LOCAL: Author Tier Visual Treatment

If `profile.author_tier == true`, the profile gets extra visual treatment:
- Gold/amber accent border on avatar
- "Author" pill badge always shown first in badge row
- Display name has a subtle âœ“ verified-style icon

This is purely CSS â€” no logic, just a conditional class:
```typescript
<div className={profile.author_tier ? "profile-card author" : "profile-card"}>
```

> This visual distinction is important â€” it helps readers instantly know they're reading content from someone who has proven consistent quality on the platform.

---

## Step 9 â€” ğŸ’» LOCAL: Alembic Migration (if needed)

M2 already created the `users` table with all profile fields (`bio`, `avatar_url`, `privacy`, etc.). No new migration is needed for M4.

If you added the `Pillow` package to requirements.txt, the Docker image will automatically install it on the next deploy.

---

## Step 10 â€” ğŸ–¥ï¸ SERVER: Deploy & Verify

After pushing code (CI/CD auto-deploys):

**Test the profile API:**
```bash
# Get profile (replace with a real username from your test account)
curl https://yotop10.com/api/users/testuser

# Expected: full profile JSON with bio, badges, post_count, etc.
```

**Test in browser:**
- Go to `https://yotop10.com/@testuser`
- Should see full profile page with SSR content (view source â†’ profile data should be in the HTML, not loaded by JS)
- Share the URL on WhatsApp or Discord â†’ OG card should show avatar + name + bio

**Test avatar upload:**
- Go to `https://yotop10.com/settings/profile`
- Upload a photo
- Should appear immediately
- Visit your profile page â€” new avatar should be there
- Check MinIO: `mc ls local/yotop10-media/avatars/` â€” your file should be listed

---

## M4 Completion Checklist

- [ ] `GET /api/users/{username}` returns full profile with privacy enforcement âœ“
- [ ] `GET /api/users/{username}/posts` returns user's post history âœ“
- [ ] `PATCH /api/users/me` updates bio, display name, privacy âœ“
- [ ] `POST /api/users/me/avatar` uploads to MinIO, returns CDN URL âœ“
- [ ] `/@ username` profile page is SSR with correct OG meta tags âœ“
- [ ] Badge row displays earned badges with hover descriptions âœ“
- [ ] Author tier gets visual treatment âœ“
- [ ] Privacy gate works (connections-only shows limited view, private shows 404) âœ“
- [ ] `/settings/profile` page works â€” avatar upload, bio edit, privacy toggle âœ“
- [ ] Verified by visiting live profile URL in browser âœ“
