# M3.5 ‚Äî Anonymous Sessions

> **Goal**: A visitor can interact with YoTop10 without creating an account. They get a persistent anonymous identity tied to their device. When they later register, their anonymous activity is optionally migrated to their new account.

---

## Why Anonymous Sessions?

Anonymous engagement dramatically increases top-of-funnel activity. A user who can fire-react to a list or drop a comment before registering is far more likely to complete signup. Without this, the platform loses every "drive-by" visitor.

**Anonymous users can:**
- Browse public lists
- React (fire) to posts and items
- Drop comments (rate-limited)
- Create up to 3 lists (pending review)

**Anonymous users cannot:**
- Follow or connect with others
- Access their own profile page
- Post more than 3 lists
- Change their username

---

## Architecture

```
Browser ‚Üí sends device fingerprint on first request
  ‚Üì
FastAPI ‚Üí checks if fingerprint exists in users table
  ‚Üì  (no)                  ‚Üì  (yes)
Create anon user         Return existing anon user JWT
Return JWT

Anon JWT stored in localStorage (not httpOnly ‚Äî anon users don't have security-critical data)
On registration ‚Üí link anon_user_id to new account ‚Üí migrate posts/reactions
```

**Device fingerprint** = hash of: `user-agent + accept-language + screen-resolution + timezone`. Not perfect but sufficient for rate-limiting and session continuity across page refreshes.

---

## Prerequisites

- M3 complete (auth system live) ‚úÖ
- M30 complete (design system ‚Äî anonymous users see the real UI) ‚úÖ

---

## Step 1 ‚Äî üíª LOCAL: Backend ‚Äî Anonymous Session Endpoint

Add to `backend/app/api/v1/auth.py`:

```python
import hashlib
from fastapi import Request

@router.post("/anonymous", status_code=201)
def create_anonymous_session(request: Request, db: Session = Depends(get_db)):
    """
    Creates or retrieves an anonymous user tied to a device fingerprint.
    Fingerprint is sent in X-Device-Fingerprint header from the frontend.
    """
    fingerprint = request.headers.get("X-Device-Fingerprint", "")
    if not fingerprint:
        raise HTTPException(400, "Device fingerprint required")

    # Look up existing anon user
    user = db.query(User).filter(
        User.device_fingerprint == fingerprint,
        User.is_anonymous == True
    ).first()

    if not user:
        # Create new anon user
        import secrets, uuid as _uuid
        anon_username = f"guest_{secrets.token_hex(6)}"
        user = User(
            id=_uuid.uuid4(),
            username=anon_username,
            display_name="Anonymous",
            auth_provider="anonymous",
            is_anonymous=True,
            is_verified=False,
            device_fingerprint=fingerprint,
        )
        db.add(user)
        db.commit()
        db.refresh(user)

    from app.core.security import create_access_token
    token = create_access_token({"sub": str(user.id)})
    return {"access_token": token, "token_type": "bearer", "is_anonymous": True}
```

---

## Step 2 ‚Äî üíª LOCAL: Frontend ‚Äî Device Fingerprint Utility

Create `frontend/src/lib/fingerprint.ts`:

```typescript
export function getDeviceFingerprint(): string {
  const components = [
    navigator.userAgent,
    navigator.language,
    `${screen.width}x${screen.height}`,
    Intl.DateTimeFormat().resolvedOptions().timeZone,
  ]
  // Simple hash ‚Äî not cryptographic, just for session continuity
  const str = components.join("|")
  let hash = 0
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i)
    hash |= 0
  }
  return Math.abs(hash).toString(36)
}
```

---

## Step 3 ‚Äî üíª LOCAL: Frontend ‚Äî Anonymous Session Hook

Create `frontend/src/hooks/useAnonymousSession.ts`:

```typescript
"use client"
import { useEffect } from "react"
import { useSession } from "next-auth/react"

const API_URL = process.env.NEXT_PUBLIC_API_URL || "/api"
const ANON_TOKEN_KEY = "yotop10_anon_token"

export function useAnonymousSession() {
  const { data: session } = useSession()

  useEffect(() => {
    // Only create anon session if not already logged in
    if (session?.user || typeof window === "undefined") return
    if (localStorage.getItem(ANON_TOKEN_KEY)) return

    const { getDeviceFingerprint } = require("@/lib/fingerprint")
    const fingerprint = getDeviceFingerprint()

    fetch(`${API_URL}/auth/anonymous`, {
      method: "POST",
      headers: { "X-Device-Fingerprint": fingerprint },
    })
      .then(r => r.json())
      .then(data => {
        if (data.access_token) {
          localStorage.setItem(ANON_TOKEN_KEY, data.access_token)
        }
      })
      .catch(() => {}) // Silent fail ‚Äî anon session is best-effort
  }, [session])
}

export function getAnonToken(): string | null {
  if (typeof window === "undefined") return null
  return localStorage.getItem(ANON_TOKEN_KEY)
}

export function clearAnonToken() {
  localStorage.removeItem(ANON_TOKEN_KEY)
}
```

---

## Step 4 ‚Äî üíª LOCAL: Wire into Root Layout

In `frontend/src/app/layout.tsx`, add `useAnonymousSession()` inside a client component wrapper so anon sessions are initialized on every page load.

---

## Step 5 ‚Äî üíª LOCAL: Account Migration on Signup

When a user registers, pass their anon token to the backend so posts/reactions can be re-attributed:

In `frontend/src/app/signup/page.tsx`, after successful registration:
```typescript
const anonToken = getAnonToken()
if (anonToken) {
  await fetch(`${API_URL}/auth/migrate-anonymous`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${data.access_token}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ anon_token: anonToken }),
  })
  clearAnonToken()
}
```

Backend endpoint `POST /auth/migrate-anonymous`:
- Decode anon_token ‚Üí get anon user_id
- Re-assign all posts/reactions/comments from anon_user_id ‚Üí new user_id
- Deactivate the anon user record

---

## Step 6 ‚Äî üñ•Ô∏è SERVER: Deploy & Verify

```bash
# After CI/CD deploys, test anonymous session creation
curl -X POST https://yotop10.com/api/auth/anonymous \
  -H "X-Device-Fingerprint: test123"

# Expected: { "access_token": "...", "token_type": "bearer", "is_anonymous": true }
```

---

## Completion Checklist

- [ ] `POST /api/auth/anonymous` endpoint live and returns a JWT
- [ ] Anonymous users appear in `users` table with `is_anonymous=true`
- [ ] Frontend creates anon session on first visit (anonymous users)
- [ ] Anon token persists across page refreshes
- [ ] Migration endpoint re-attributes anon content on signup
- [ ] Rate limits apply to anon users (max 3 posts, 10 comments/day)
